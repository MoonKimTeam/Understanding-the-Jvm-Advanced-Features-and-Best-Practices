# ch12. 자바 메모리 모델과 스레드

- 멀티태스킹, 동시성, 높은 TPS 중요해짐
- 자바와 가상머신은 동시성 프로그램 잘 지원

## 하드웨어에서 효율과 일관성

- 물리 컴퓨터의 동시성 문제처럼 캐시 레이어 두기
    - 캐시 일관성 문제(여러 프로세서가 자신만의 캐시를 갖춘 채 메인 메모리 공유 할 때 어떤 것을 기준으로 삼을지)
    - 해결 위해서는 정해진 프로토콜 따라야 함

## 자바 메모리 모델

- 자바는 C, C++와 다르게 운영체제의 메모리 직접 사용하지 않고 따로 자바 메모리 모델 사용

### 메인 메모리와 작업 메모리

- 자바 메모리 모델은 모든 변수가 메인 메모리에 저장됨
- 각 스레드는 자체 작업 메모리를 가짐

### 메모리 간 상호 작용

- 메인 메모리와 작업 메모리 사이의 프로토콜
    - 잠기, 잠금 해제, 읽기, 적재, 사용, 할당, 저장, 쓰

### volatile 변수용 특별 규칙

- JVM이 제공하는 가장 가벼운 동기화 메커니즘
- `volatile`은 "잘" 이해하면 synchronized 보다 도움 됨
    - 모든 스레드에서 이 변수를 투명하게 볼 수 있음(수정 시 다른 스레드들도 즉시 알게 됨)
    - 명령어 재정렬 최적화를 막아줌

### long과 double 변수용 특별 규칙

- 64 비트 데이터의 적재, 저장, 읽기, 쓰기, 연산의 원자성을 보장할지 여부를 선택 가능
- `AlwaysAtomicAccesses`

### 자바 메모리 모델의 특성들

#### 원자성

- 기본 데이터 타입은 long, double 제외하고 원자적

#### 가시성

- 공유 변수의 값을 한 스레드가 수정하면 수정 결과를 다른 스레드가 즉시 알 수 있음
    - syncronized, final이 가시성 있는 이유
        - synchronzed는 변수 잠금 해제전 메인 메모리와 동기화 필요, final은 생성자에서 초기화되고, 생성 전 참조를 다른 스레드에 전달 불가

#### 실행 순서

- 현재 스레드에서 보면 모든 연산이 순서대로 수행되지만 다른 스레드에서는 다를 수 있음
    - 명령어 재정렬, 작업 메모리와 메인 메모리 사이 동기화 지연 때문

#### 선 발생 원칙

- 작업 A가 B보다 선 발생 -> 작업 B가 수행되기 전 작업 A의 영향을 작업 B에서 관찰 가능함을 의미

## 자바와 스레드

### 스레드 구현

- 스레드 각각은 프로세스 자원을 공유하고 독립적으로 스케줄링 됨

#### 커널 스레드 구현

- 운영체제 커널에서 직접 지원하는 스레드
- 스레드의 작업을 각 프로세서에 메핑하는 역할

#### 사용자 스레드 구현

- 넓은 의미: 커널 스레드가 아닌 모든 스레드
    - 그러나 경량 프로세스는 항상 커널 기반하여 비효율적
- 좁은 의미: 온전히 사용자 공간에서 구현되는 스레드 라이브러리

#### 하이브리드 구현

- 커널 스레드와 사용자 스레드를 함께 이용

#### 자바 스레드 구현

- JDK 1.3부터는 주류 가상 머신들이 운영체제의 기본 스레드 모델 기반하기 시작

### 자바 스레드 스케줄링

- 시스템이 프로세서 사용 권한을 스레드에 할당하는 일

### 상태 전이

- 자바 스레드 상태(6가지)
    - 신규, 실행 중, 무기한 대기, 시간제한 대기, 블록, 종료

## 자바와 가상 스레드

- 자바는 운영 체제별 스레드 모델의 차이를 숨기는 통합된 스레드 인터페이스를 제공함

### 커널 스레드의 한계

- 자바 동시성 프로그래밍 메커니즘은 MSA와 어울리지 않음
    - 모놀리식에서보다 스레드 전환 비용 문제가 부각됨
- 기존 자바 웹 서버의 스레드 풀 용량은 수십 ~ 200개 -> 초과 시 처리 할 는 있더라도 전환 손실

### 코루틴의 귀환

- 커널 스레드는 비효율적
- 멀티스레딩이 운영체제 차원에서 지원하기 시작하면서 사용자 스레드가 코루틴(스택풀 코루틴)이라는 별칭으로 불리기 시작함
- 코루틴 장점: 가벼움
    - 스택리스 코루틴은 스택 복원 비용이 더 싸지만 기능은 제한적
- 단점
    - 호출 스택과 스케줄러 등 많은 것을 애플리케이션 수준에서 구현해야 함

### 가상 스레드:자바의 해법

- 스택풀 코루틴 예시: 파이버